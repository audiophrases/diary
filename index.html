<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diary</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #0c161d;
      --chat-bg: #e7ddd7;
      
      --header: #075e54;
      --accent: #25d366;
      --text: #111;
      --muted: #6b7280;
      --bubble: #ffffff;
      --bubble-self: #dcf8c6;
      --bubble-guest: #ffffff;
      --border: rgba(0,0,0,0.06);
      --shadow: 0 10px 50px rgba(0,0,0,0.25);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 12% 18%, rgba(37,211,102,0.06), transparent 26%),
                  radial-gradient(circle at 78% 0%, rgba(18,140,126,0.14), transparent 30%),
                  var(--bg);
      background-attachment: fixed;
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 0;
    }

    .app {
      width: min(1200px, 100vw);
      min-height: var(--app-height, 100dvh);
      height: var(--app-height, 100dvh);
      max-height: var(--app-height, 100dvh);
      background: #f5f3f1;
      border-radius: 0;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr auto;
      border: 1px solid var(--border);
    }

    header {
      background: linear-gradient(135deg, var(--header), #128c7e);
      color: #fff;
      padding: 18px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 3;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.2px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill-btn {
      border: 1px solid rgba(255,255,255,0.6);
      background: rgba(0,0,0,0.12);
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.2px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease;
    }

    .pill-btn:hover { background: rgba(0,0,0,0.2); transform: translateY(-1px); }
    .pill-btn.secondary { border-color: rgba(255,255,255,0.35); color: #e0f2f1; }

    .status {
      font-size: 12px;
      color: #d1fae5;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(0,0,0,0.12);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
    }

    .status span {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      box-shadow: 0 0 0 6px rgba(34,197,94,0.25);
    }

    .chat {
      position: relative;
      background-color: var(--chat-bg);
      background-image: url('pattern.svg');
      background-repeat: repeat;
      background-size: 240px 240px;
      background-attachment: fixed;
      color: #2f6f5f;
      padding: 24px 18px 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
      min-height: 0;
    }

    .chat::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        linear-gradient(rgba(245,243,241,0.22), rgba(245,243,241,0.12)),
        var(--pattern-color);
      background-attachment: fixed, fixed;
      background-repeat: repeat;
      background-size: 240px 240px;
      mix-blend-mode: multiply;
      opacity: 0.4;
      z-index: 0;
      pointer-events: none;
      transform: translateZ(0);
    }

    .chat > * { position: relative; z-index: 2; }

    .empty {
      text-align: center;
      color: var(--muted);
      margin: 60px auto;
      max-width: 360px;
      line-height: 1.6;
      background: rgba(255,255,255,0.8);
      border-radius: 18px;
      padding: 24px 20px;
      border: 1px dashed #d1d5db;
    }

    .day-label {
      align-self: center;
      background: rgba(7,94,84,0.12);
      color: #065f46;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(7,94,84,0.18);
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }

    .message {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .bubble {
      max-width: min(80%, 760px);
      padding: 12px 14px 10px;
      border-radius: 16px;
      background: var(--bubble);
      position: relative;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
      transition: box-shadow 0.15s ease, transform 0.15s ease;
      cursor: pointer;
    }

    .bubble:hover { box-shadow: 0 12px 28px rgba(0,0,0,0.14); transform: translateY(-1px); }

    .message.self { justify-content: flex-end; }
    .message.self .bubble { background: var(--bubble-self); border-top-right-radius: 4px; }

    .message.guest { justify-content: flex-start; }
    .message.guest .bubble { background: var(--bubble-guest); border-top-left-radius: 4px; }

    .text {
      margin: 0 0 8px;
      white-space: pre-wrap;
      word-break: break-word;
      color: #0f172a;
    }

    .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .meta .sender {
      background: rgba(0,0,0,0.04);
      padding: 4px 8px;
      border-radius: 8px;
      color: #111827;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .meta .sender.guest { color: #065f46; background: rgba(7,94,84,0.12); }

    button.inline {
      border: none;
      background: transparent;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      border-radius: 8px;
      transition: background 0.2s ease, color 0.2s ease;
    }

    button.inline:hover { background: rgba(0,0,0,0.06); color: #ef4444; }

    .audio-player {
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .photo {
      width: 100%;
      max-height: 320px;
      border-radius: 12px;
      object-fit: cover;
      margin-bottom: 8px;
      border: 1px solid var(--border);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(37,211,102,0.15);
      color: #065f46;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(37,211,102,0.35);
    }

    .text a {
      color: #2563eb;
      text-decoration: underline;
      word-break: break-word;
    }

    .link-preview {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #f8fafc;
      overflow: hidden;
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
      text-decoration: none;
      color: inherit;
      box-shadow: 0 8px 20px rgba(15,23,42,0.08);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .link-preview:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15,23,42,0.12);
    }

    .link-preview .link-thumbnail {
      width: 120px;
      height: 100%;
      object-fit: cover;
      background: #0f172a;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 22px;
    }

    .link-preview .link-content {
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
    }

    .link-preview .link-title {
      font-weight: 600;
      color: #0f172a;
      font-size: 14px;
      line-height: 1.3;
    }

    .link-preview .link-domain {
      font-size: 12px;
      color: #64748b;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .upload-input {
      display: none;
    }

    .footer {
      padding: 12px 16px 16px;
      background: #f8f7f6;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .controls {
      display: grid;
      grid-template-columns: auto 1fr auto auto auto;
      gap: 10px;
      align-items: center;
    }

    .input { position: relative; }

    textarea {
      width: 100%;
      min-height: 46px;
      max-height: 120px;
      resize: vertical;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px 14px 12px 44px;
      font-family: inherit;
      font-size: 15px;
      background: #fff;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, height 0.15s ease;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
    }

    textarea:focus { border-color: #16a34a; box-shadow: 0 0 0 4px rgba(22,163,74,0.15); }
    textarea:disabled { background: #f3f4f6; color: #9ca3af; }

    .control-btn {
      height: 46px;
      width: 46px;
      border-radius: 50%;
      border: none;
      background: #fff;
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease, border 0.2s ease;
    }

    .control-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,0.12); }
    .control-btn:disabled { cursor: not-allowed; opacity: 0.55; box-shadow: none; transform: none; }

    .send-btn {
      background: linear-gradient(135deg, #25d366, #128c7e);
      color: #fff;
      border: none;
      padding: 0 22px;
      border-radius: 999px;
      font-weight: 600;
      letter-spacing: 0.2px;
      height: 46px;
      cursor: pointer;
      box-shadow: 0 12px 20px rgba(18,140,126,0.28);
      transition: transform 0.1s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

    .send-btn:hover { transform: translateY(-1px); }
    .send-btn:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(18,140,126,0.25); }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

    .emoji-tray {
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: calc(100% + 10px);
      top: auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(36px, 1fr));
      gap: 6px;
      padding: 12px 12px 10px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.18);
      border: 1px solid var(--border);
      width: min(380px, calc(100vw - 40px));
      max-height: 260px;
      overflow: auto;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: opacity 0.16s ease, transform 0.16s ease;
      z-index: 4;
      align-items: flex-start;
      justify-items: center;
    }

    .emoji-tray.open { opacity: 1; visibility: visible; transform: translateY(0); }

    .emoji-tray button {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 10px;
      width: 100%;
      min-height: 38px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-tray button:hover { background: rgba(0,0,0,0.06); }

    .emoji-group-title {
      grid-column: 1 / -1;
      width: 100%;
      text-align: left;
      font-size: 12px;
      color: #6b7280;
      font-weight: 700;
      margin-top: 6px;
    }

    .input .emoji-toggle {
      position: absolute;
      left: 8px;
      top: 8px;
      z-index: 5;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      color: #777;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--muted);
      font-size: 13px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .recording { display: inline-flex; align-items: center; gap: 8px; color: #b91c1c; font-weight: 600; }
    .pulse { width: 10px; height: 10px; background: #ef4444; border-radius: 50%; box-shadow: 0 0 0 8px rgba(239,68,68,0.2); animation: pulse 1.4s infinite; }

    @keyframes pulse { 0% { box-shadow: 0 0 0 6px rgba(239,68,68,0.35); } 70% { box-shadow: 0 0 0 14px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 6px rgba(239,68,68,0); } }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 10;
    }

    .modal.open { display: flex; }

    .modal-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 640px;
      width: min(640px, 100%);
      padding: 18px;
      border: 1px solid var(--border);
    }

    .modal-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px; }
    .modal-header h3 { margin: 0; }

    .bin-list { display: flex; flex-direction: column; gap: 12px; max-height: 360px; overflow: auto; }
    .bin-item { border: 1px solid var(--border); padding: 12px; border-radius: 12px; background: #f9fafb; }
    .bin-actions { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(37,99,235,0.1);
      color: #1d4ed8;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid rgba(37,99,235,0.18);
    }

    .edit-area textarea { width: 100%; min-height: 80px; padding: 10px 12px; }
    .edit-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }

    .camera-preview { width: 100%; border-radius: 14px; background: #000; aspect-ratio: 16 / 9; object-fit: contain; }
    .camera-status { color: #b91c1c; font-weight: 600; }

    @media (max-width: 900px) {
      .app { border-radius: 0; }
      header { flex-direction: column; align-items: flex-start; gap: 10px; }
      .header-actions { width: 100%; justify-content: flex-start; }
    }

    @media (max-width: 680px) {
      body { align-items: stretch; }
      .app { width: 100%; max-width: 100%; }
      .bubble { max-width: 94%; }
      .controls { grid-template-columns: auto 1fr auto; grid-template-areas: "record input send" "camera input send" "upload input send"; align-items: stretch; }
      #recordBtn { grid-area: record; }
      .input { grid-area: input; }
      #cameraBtn { grid-area: camera; }
      #uploadBtn { grid-area: upload; }
      #sendBtn { grid-area: send; width: 100%; }
      textarea { padding-left: 42px; }
      .footer { padding: 12px; }
    }

    @media (max-width: 520px) {
      header h1 { font-size: 18px; }
      .status { width: 100%; justify-content: center; }
      .header-actions { flex-direction: column; align-items: stretch; }
      .controls { grid-template-columns: 1fr; grid-template-areas: "input" "record" "camera" "upload" "send"; }
      #recordBtn, #cameraBtn, #uploadBtn, #sendBtn { width: 100%; }
      .row { align-items: flex-start; gap: 6px; }
    }
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div>
        <h1>Diary</h1>
      </div>
      <div class="header-actions">
        <button class="pill-btn" id="guestToggle" aria-pressed="false">Guest: Off</button>
        <button class="pill-btn secondary" id="binBtn" aria-label="Open recycle bin">üóëÔ∏è Recycle bin</button>
      </div>
    </header>

    <main class="chat" id="chat" aria-live="polite" aria-label="Diary message history"></main>

    <div class="footer">
      <div class="controls">
        <button class="control-btn" id="recordBtn" aria-pressed="false" aria-label="Record a voice note">üéôÔ∏è</button>
        <div class="input">
          <button class="emoji-toggle" id="emojiToggle" aria-label="Toggle emoji picker">üòä</button>
          <textarea id="messageInput" placeholder="Write a diary message..." aria-label="Write a diary message"></textarea>
          <div class="emoji-tray" id="emojiTray" role="grid" aria-hidden="true"></div>
        </div>
        <button class="control-btn" id="uploadBtn" aria-label="Upload a photo">üñºÔ∏è</button>
        <input class="upload-input" id="photoInput" type="file" accept="image/*" multiple>
        <button class="control-btn" id="cameraBtn" aria-label="Open camera">üì∑</button>
        <button class="send-btn" id="sendBtn">Send</button>
      </div>
      <div class="row">
        <div id="hint"></div>
        <div id="recordingState"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="binModal" role="dialog" aria-modal="true" aria-labelledby="binTitle">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="binTitle">Recycle bin</h3>
        <button class="inline" id="closeBin" aria-label="Close recycle bin">‚úñ</button>
      </div>
      <div class="bin-list" id="binList"></div>
    </div>
  </div>

  <div class="modal" id="cameraModal" role="dialog" aria-modal="true" aria-labelledby="cameraTitle">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="cameraTitle">Camera</h3>
        <button class="inline" id="closeCamera" aria-label="Close camera">‚úñ</button>
      </div>
      <video id="cameraPreview" class="camera-preview" autoplay playsinline muted></video>
      <div id="cameraError" class="camera-status" style="margin: 10px 0 0 0;"></div>
      <div class="bin-actions" style="margin-top: 12px; justify-content: flex-end;">
        <button class="pill-btn secondary" id="capturePhoto">üì∏ Capture</button>
      </div>
    </div>
  </div>

  <script>
    const storageKey = 'diary-messages';
    const deletedStorageKey = 'diary-deleted-messages';
    const chat = document.getElementById('chat');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const recordBtn = document.getElementById('recordBtn');
    const recordingState = document.getElementById('recordingState');
    const emojiToggle = document.getElementById('emojiToggle');
    const emojiTray = document.getElementById('emojiTray');
    const hint = document.getElementById('hint');
    const binBtn = document.getElementById('binBtn');
    const binModal = document.getElementById('binModal');
    const closeBin = document.getElementById('closeBin');
    const binList = document.getElementById('binList');
    const cameraBtn = document.getElementById('cameraBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const photoInput = document.getElementById('photoInput');
    const cameraModal = document.getElementById('cameraModal');
    const closeCamera = document.getElementById('closeCamera');
    const cameraPreview = document.getElementById('cameraPreview');
    const cameraError = document.getElementById('cameraError');
    const capturePhotoBtn = document.getElementById('capturePhoto');
    const guestToggle = document.getElementById('guestToggle');

    let messages = [];
    let deletedMessages = [];
    let mediaRecorder = null;
    let audioChunks = [];
    let cameraStream = null;
    let guestMode = false;
    let guestName = '';
    let activeEditor = null;
    const guestNameKey = 'diary-guest-name';
    const root = document.documentElement;
    let viewportHandlerAttached = false;
    const urlPattern = /https?:\/\/[^\s]+/g;

    const emojiGroups = [
      { label: 'Smiles & moods', items: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','ü•π','üòä','üòç','üòò','üòá','ü§î','ü§ó','üò¥','ü§ì','ü•≥','üòé','üò≠','üòÖ','üòå','üò¨','üòµ‚Äçüí´','ü§Ø','üò§','üòÆ‚Äçüí®','ü•±','ü§©'] },
      { label: 'Reactions & feelings', items: ['ü•∞','ü´∂','ü§ç','üíö','üíô','üíõ','üß°','‚ù§Ô∏è','üíî','üíû','üí´','‚ú®','üî•','üôå','üëè','üôè','ü§ù','üëç','üëé','ü§û','‚úåÔ∏è','üëå','ü§ô','ü§å','ü´†','ü´£','ü´®','üßò','üß†','üí≠'] },
      { label: 'Nature & sky', items: ['üåø','üåô','üå§Ô∏è','üåßÔ∏è','üåà','üå∏','üåª','üåµ','üçÄ','üçÇ','üçÅ','üåä','ü™º','üçÉ','üå¨Ô∏è','‚ùÑÔ∏è'] },
      { label: 'Objects & cozy', items: ['‚òï','üìå','üéß','üìñ','üìù','üéØ','üè°','üõãÔ∏è','üß∏','üí§','üõ∏','üïØÔ∏è','üì∑','üéµ','üé∂','ü´ß'] }
    ];

    function generateId() {
      if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
        return crypto.randomUUID();
      }
      const now = typeof performance !== 'undefined' && typeof performance.now === 'function' ? performance.now() : Date.now();
      const random = (crypto?.getRandomValues?.(new Uint32Array(4)) || [Date.now(), Math.random() * 1e9, now, Math.random() * 1e9])
        .map((part) => Math.floor(part).toString(16).padStart(8, '0'))
        .join('-');
      return `msg-${random}`;
    }

    function backupRawStorage(key, raw) {
      if (!raw) return;
      try {
        localStorage.setItem(`${key}-backup`, raw);
      } catch (error) {
        console.warn('Unable to write backup copy', error);
      }
    }

    function parseStoredJSON(key) {
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch (error) {
        console.error(`Unable to parse stored data for ${key}`, error);
        backupRawStorage(key, raw);
        return null;
      }
    }

    function toEntryArray(value) {
      if (Array.isArray(value)) return value;
      if (value && typeof value === 'object') {
        if (Array.isArray(value.messages)) return value.messages;
        if (Array.isArray(value.items)) return value.items;
        const objectValues = Object.values(value).filter((item) => typeof item === 'string' || (item && typeof item === 'object'));
        if (objectValues.length) return objectValues;
      }
      if (typeof value === 'string' && value.trim()) return [value.trim()];
      return [];
    }

    function normalizeEntry(entry) {
      const allowedTypes = ['text', 'audio', 'photo'];
      if (typeof entry === 'string') {
        return { id: generateId(), type: 'text', content: entry, createdAt: new Date().toISOString(), sender: 'primary' };
      }
      if (!entry || typeof entry !== 'object') return null;
      const type = allowedTypes.includes(entry.type) ? entry.type : 'text';
      const content = typeof entry.content === 'string' ? entry.content : '';
      if (!content) return null;
      return {
        id: entry.id || generateId(),
        type,
        content,
        createdAt: entry.createdAt || new Date().toISOString(),
        sender: entry.sender === 'guest' ? 'guest' : 'primary',
        guestName: typeof entry.guestName === 'string' ? entry.guestName : undefined
      };
    }

    function loadCollection(key) {
      const parsed = parseStoredJSON(key);
      const entries = toEntryArray(parsed);
      const normalized = entries.map((entry) => normalizeEntry(entry)).filter(Boolean);
      return normalized;
    }

    function loadMessages() {
      messages = loadCollection(storageKey);
      deletedMessages = loadCollection(deletedStorageKey);
    }

    function persistAll() {
      try {
        localStorage.setItem(storageKey, JSON.stringify(messages));
        localStorage.setItem(deletedStorageKey, JSON.stringify(deletedMessages));
      } catch (error) {
        console.error('Unable to save diary messages', error);
      }
    }

    function currentSender() {
      return guestMode ? 'guest' : 'primary';
    }

    function formatClock(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString(undefined, { hour: 'numeric', minute: '2-digit' });
    }

    function formatHeading(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString(undefined, {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    }

    function dayKey(dateStr) {
      return new Date(dateStr).toDateString();
    }

    function extractUrls(text) {
      if (!text) return [];
      return text.match(urlPattern) || [];
    }

    function linkifyText(text) {
      const fragment = document.createDocumentFragment();
      if (!text) return fragment;
      const matches = [...text.matchAll(urlPattern)];
      if (!matches.length) {
        fragment.appendChild(document.createTextNode(text));
        return fragment;
      }
      let lastIndex = 0;
      matches.forEach((match) => {
        const matchIndex = match.index ?? 0;
        const url = match[0];
        if (matchIndex > lastIndex) {
          fragment.appendChild(document.createTextNode(text.slice(lastIndex, matchIndex)));
        }
        const link = document.createElement('a');
        link.href = url;
        link.textContent = url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        fragment.appendChild(link);
        lastIndex = matchIndex + url.length;
      });
      if (lastIndex < text.length) {
        fragment.appendChild(document.createTextNode(text.slice(lastIndex)));
      }
      return fragment;
    }

    function parseYouTubeId(url) {
      try {
        const parsed = new URL(url);
        const hostname = parsed.hostname.replace('www.', '');
        if (hostname === 'youtu.be') {
          return parsed.pathname.replace('/', '').split('/')[0];
        }
        if (hostname === 'youtube.com' || hostname.endsWith('.youtube.com')) {
          if (parsed.pathname.startsWith('/watch')) {
            return parsed.searchParams.get('v');
          }
          if (parsed.pathname.startsWith('/shorts/')) {
            return parsed.pathname.split('/')[2];
          }
        }
      } catch (error) {
        return null;
      }
      return null;
    }

    function buildLinkPreview(url) {
      let hostname = '';
      try {
        hostname = new URL(url).hostname.replace('www.', '');
      } catch (error) {
        return null;
      }
      const youtubeId = parseYouTubeId(url);
      const preview = document.createElement('a');
      preview.className = 'link-preview';
      preview.href = url;
      preview.target = '_blank';
      preview.rel = 'noopener noreferrer';

      if (youtubeId) {
        const thumb = document.createElement('img');
        thumb.className = 'link-thumbnail';
        thumb.src = `https://img.youtube.com/vi/${youtubeId}/hqdefault.jpg`;
        thumb.alt = 'YouTube preview';
        preview.appendChild(thumb);
      } else {
        const thumb = document.createElement('div');
        thumb.className = 'link-thumbnail';
        thumb.textContent = 'üîó';
        preview.appendChild(thumb);
      }

      const content = document.createElement('div');
      content.className = 'link-content';

      const title = document.createElement('div');
      title.className = 'link-title';
      title.textContent = youtubeId ? 'YouTube video' : 'Shared link';

      const domain = document.createElement('div');
      domain.className = 'link-domain';
      domain.textContent = youtubeId ? `‚ñ∂Ô∏è ${hostname}` : `üîó ${hostname}`;

      content.append(title, domain);
      preview.appendChild(content);
      return preview;
    }

    function addMessage({ type, content, createdAt = new Date().toISOString(), sender = currentSender(), guestName: providedGuestName }) {
      const newMessage = { id: generateId(), type, content, createdAt, sender };
      if (sender === 'guest') {
        const name = ((providedGuestName ?? guestName) || '').trim();
        newMessage.guestName = name || undefined;
      }
      messages.push(newMessage);
      persistAll();
      renderMessages();
    }

    function moveToBin(id) {
      const index = messages.findIndex((m) => m.id === id);
      if (index === -1) return;
      const [removed] = messages.splice(index, 1);
      deletedMessages.unshift(removed);
      persistAll();
      renderMessages();
      renderBin();
    }

    function restoreMessage(id) {
      const index = deletedMessages.findIndex((m) => m.id === id);
      if (index === -1) return;
      const [restored] = deletedMessages.splice(index, 1);
      messages.push(restored);
      messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
      persistAll();
      renderMessages();
      renderBin();
    }

    function deleteForever(id) {
      deletedMessages = deletedMessages.filter((m) => m.id !== id);
      persistAll();
      renderBin();
    }

    function sendTextMessage() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        stopRecordingAndSave();
        return;
      }
      const text = input.value.trim();
      if (!text) return;
      addMessage({ type: 'text', content: text });
      input.value = '';
      input.focus();
    }

    async function startRecording() {
      if (!navigator.mediaDevices?.getUserMedia || typeof MediaRecorder === 'undefined') {
        alert('Voice notes are not supported in this browser.');
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };

        mediaRecorder.onstop = async () => {
          if (!audioChunks.length) {
            setRecordingState(false);
            toggleComposerDisabled(false);
            return;
          }
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const reader = new FileReader();
          reader.onloadend = () => {
            addMessage({ type: 'audio', content: reader.result });
            toggleComposerDisabled(false);
          };
          reader.readAsDataURL(blob);
          setRecordingState(false);
          cleanupRecorder();
        };

        mediaRecorder.start();
        setRecordingState(true);
      } catch (error) {
        console.error('Recording failed', error);
        alert('Unable to access microphone. Please allow access to record voice notes.');
        setRecordingState(false);
        toggleComposerDisabled(false);
      }
    }

    function cleanupRecorder() {
      if (!mediaRecorder) return;
      mediaRecorder.stream.getTracks().forEach((t) => t.stop());
      mediaRecorder = null;
    }

    function stopRecordingAndSave() {
      if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
      toggleComposerDisabled(true);
      mediaRecorder.stop();
    }

    function setRecordingState(active) {
      recordBtn.setAttribute('aria-pressed', String(active));
      recordBtn.textContent = active ? '‚èπÔ∏è' : 'üéôÔ∏è';
      sendBtn.textContent = active ? 'Send clip' : 'Send';
      recordingState.innerHTML = active ? '<span class="recording"><span class="pulse"></span>Recording...</span>' : '';
      hint.style.opacity = active ? '0.35' : '1';
      sendBtn.disabled = false;
    }

    function toggleRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        stopRecordingAndSave();
      } else {
        startRecording();
      }
    }

    function buildEmojiTray() {
      emojiTray.innerHTML = '';
      emojiGroups.forEach((group) => {
        const title = document.createElement('div');
        title.className = 'emoji-group-title';
        title.textContent = group.label;
        emojiTray.appendChild(title);
        group.items.forEach((emoji) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.innerText = emoji;
          btn.addEventListener('click', () => {
            input.value += emoji;
            input.focus();
          });
          emojiTray.appendChild(btn);
        });
      });
    }

    function toggleEmojiTray() {
      const open = emojiTray.classList.toggle('open');
      emojiTray.setAttribute('aria-hidden', String(!open));
    }

    function toggleComposerDisabled(state) {
      input.disabled = state;
      recordBtn.disabled = state;
      sendBtn.disabled = state;
      cameraBtn.disabled = state;
      emojiToggle.disabled = state;
      uploadBtn.disabled = state;
      photoInput.disabled = state;
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        chat.scrollTop = chat.scrollHeight;
      });
    }

    function updateAppHeight() {
      const viewport = window.visualViewport;
      const viewportHeight = viewport ? viewport.height : 0;
      const fallback = window.innerHeight || document.documentElement.clientHeight || 0;
      const height = Math.max(viewportHeight, fallback);
      root.style.setProperty('--app-height', `${height}px`);
    }

    function bindViewportListeners() {
      if (viewportHandlerAttached) return;
      viewportHandlerAttached = true;
      const viewport = window.visualViewport;
      if (viewport) {
        viewport.addEventListener('resize', updateAppHeight);
        viewport.addEventListener('scroll', updateAppHeight);
      }
      window.addEventListener('resize', updateAppHeight);
    }

    function renderMessages() {
      chat.innerHTML = '';
      let lastDay = '';

      if (!messages.length) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.innerHTML = 'No diary entries yet. Everything stays on this device. Write a thought, drop an emoji, or record a voice reflection.';
        chat.appendChild(empty);
        return;
      }

      messages.forEach((msg) => {
        const sender = msg.sender || 'primary';
        const currentDay = dayKey(msg.createdAt);
        if (currentDay !== lastDay) {
          const label = document.createElement('div');
          label.className = 'day-label';
          label.textContent = formatHeading(msg.createdAt);
          chat.appendChild(label);
          lastDay = currentDay;
        }

        const row = document.createElement('div');
        row.className = 'message';
        if (sender === 'primary') row.classList.add('self');
        if (sender === 'guest') row.classList.add('guest');
        row.dataset.id = msg.id;

        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        if (msg.type === 'text') {
          const text = document.createElement('p');
          text.className = 'text';
          text.appendChild(linkifyText(msg.content));
          bubble.appendChild(text);

          const urls = extractUrls(msg.content);
          urls.forEach((url) => {
            const preview = buildLinkPreview(url);
            if (preview) bubble.appendChild(preview);
          });
        }

        if (msg.type === 'audio') {
          const audioWrap = document.createElement('div');
          audioWrap.className = 'audio-player';

          const label = document.createElement('div');
          label.className = 'pill';
          label.textContent = 'Voice note';

          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = msg.content;

          audioWrap.append(label, audio);
          bubble.appendChild(audioWrap);
        }

        if (msg.type === 'photo') {
          const img = document.createElement('img');
          img.className = 'photo';
          img.src = msg.content;
          img.alt = 'Diary photo';
          bubble.appendChild(img);
        }

        const meta = document.createElement('div');
        meta.className = 'meta';

        const leftMeta = document.createElement('div');
        leftMeta.style.display = 'flex';
        leftMeta.style.gap = '8px';
        leftMeta.style.alignItems = 'center';
        leftMeta.style.flexWrap = 'wrap';

        if (sender === 'guest') {
          const guestLabel = (msg.guestName || '').trim();
          if (guestLabel) {
            const guestTag = document.createElement('span');
            guestTag.className = 'sender guest';
            guestTag.textContent = guestLabel;
            leftMeta.appendChild(guestTag);
          }
        } else {
          const me = document.createElement('span');
          me.className = 'sender';
          me.textContent = 'You';
          leftMeta.appendChild(me);
        }

        const time = document.createElement('span');
        time.textContent = formatClock(msg.createdAt);
        leftMeta.appendChild(time);

        const metaActions = document.createElement('div');
        metaActions.style.display = 'inline-flex';
        metaActions.style.gap = '6px';

        const del = document.createElement('button');
        del.className = 'inline';
        del.innerText = 'üóëÔ∏è';
        del.title = 'Delete entry';
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          moveToBin(msg.id);
        });

        metaActions.appendChild(del);
        meta.append(leftMeta, metaActions);
        bubble.appendChild(meta);

        if (msg.type === 'text') {
          bubble.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('a')) return;
            openEditor(row, bubble, msg);
          });
          bubble.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              openEditor(row, bubble, msg);
            }
          });
        }

        row.appendChild(bubble);
        chat.appendChild(row);
      });

      scrollToBottom();
    }

    function openEditor(row, bubble, msg) {
      if (activeEditor === msg.id) return;
      activeEditor = msg.id;
      bubble.innerHTML = '';

      const area = document.createElement('div');
      area.className = 'edit-area';
      const editInput = document.createElement('textarea');
      editInput.value = msg.content;
      editInput.autofocus = true;
      area.appendChild(editInput);

      const actions = document.createElement('div');
      actions.className = 'edit-actions';
      const cancel = document.createElement('button');
      cancel.className = 'pill-btn secondary';
      cancel.textContent = 'Cancel';
      cancel.addEventListener('click', (e) => {
        e.stopPropagation();
        activeEditor = null;
        renderMessages();
      });

      const save = document.createElement('button');
      save.className = 'pill-btn';
      save.textContent = 'Save';
      save.addEventListener('click', (e) => {
        e.stopPropagation();
        const updated = editInput.value.trim();
        if (!updated) return;
        msg.content = updated;
        persistAll();
        activeEditor = null;
        renderMessages();
      });

      actions.append(cancel, save);
      area.appendChild(actions);
      bubble.appendChild(area);
      editInput.focus();
    }

    function attachEvents() {
      sendBtn.addEventListener('click', sendTextMessage);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendTextMessage();
        }
      });
      input.addEventListener('focus', () => {
        setTimeout(() => {
          updateAppHeight();
          scrollToBottom();
        }, 80);
      });

      recordBtn.addEventListener('click', toggleRecording);
      emojiToggle.addEventListener('click', toggleEmojiTray);
      uploadBtn.addEventListener('click', () => photoInput.click());
      photoInput.addEventListener('change', handlePhotoUpload);
      cameraBtn.addEventListener('click', openCameraModal);

      document.addEventListener('click', toggleEmojiOutside);

      binBtn.addEventListener('click', () => binModal.classList.add('open'));
      closeBin.addEventListener('click', () => binModal.classList.remove('open'));
      binModal.addEventListener('click', (e) => {
        if (e.target === binModal) binModal.classList.remove('open');
      });

      cameraModal.addEventListener('click', (e) => {
        if (e.target === cameraModal) closeCameraModal();
      });
      closeCamera.addEventListener('click', closeCameraModal);
      capturePhotoBtn.addEventListener('click', capturePhoto);

      guestToggle.addEventListener('click', toggleGuestMode);
    }

    function toggleGuestMode() {
      if (!guestMode) {
        const defaultName = guestName || localStorage.getItem(guestNameKey) || '';
        const response = prompt('Enter a display name for this guest', defaultName);
        if (response === null) return;
        const trimmed = response.trim();
        if (!trimmed) return;
        guestName = trimmed;
        localStorage.setItem(guestNameKey, guestName);
        guestMode = true;
      } else {
        guestMode = false;
        guestName = '';
        localStorage.removeItem(guestNameKey);
      }

      guestToggle.setAttribute('aria-pressed', String(guestMode));
      guestToggle.textContent = guestMode ? `Guest: ${guestName}` : 'Guest: Off';
      hint.textContent = guestMode ? `Guest session active as ${guestName}. Messages send as guest and align left.` : '';
    }

    function renderBin() {
      binList.innerHTML = '';
      if (!deletedMessages.length) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'Recycle bin is empty. Deleted items will appear here until removed forever.';
        binList.appendChild(empty);
        return;
      }

      deletedMessages.forEach((msg) => {
        const item = document.createElement('div');
        item.className = 'bin-item';

        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.gap = '8px';
        header.style.alignItems = 'center';

        const tags = document.createElement('div');
        tags.style.display = 'flex';
        tags.style.gap = '6px';
        tags.style.flexWrap = 'wrap';

        const typeTag = document.createElement('span');
        typeTag.className = 'tag';
        typeTag.textContent = msg.type;
        tags.appendChild(typeTag);

        const timeTag = document.createElement('span');
        timeTag.className = 'tag';
        timeTag.textContent = formatHeading(msg.createdAt);
        tags.appendChild(timeTag);

        if (msg.sender === 'guest') {
          const guestLabel = (msg.guestName || '').trim();
          if (guestLabel) {
            const guestTag = document.createElement('span');
            guestTag.className = 'tag';
            guestTag.textContent = guestLabel;
            tags.appendChild(guestTag);
          }
        }

        header.appendChild(tags);
        item.appendChild(header);

        if (msg.type === 'text') {
          const preview = document.createElement('p');
          preview.textContent = msg.content;
          item.appendChild(preview);
        }

        if (msg.type === 'photo') {
          const img = document.createElement('img');
          img.src = msg.content;
          img.alt = 'Deleted photo';
          img.className = 'photo';
          item.appendChild(img);
        }

        if (msg.type === 'audio') {
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = msg.content;
          item.appendChild(audio);
        }

        const actions = document.createElement('div');
        actions.className = 'bin-actions';
        const restoreBtn = document.createElement('button');
        restoreBtn.className = 'pill-btn';
        restoreBtn.textContent = 'Restore';
        restoreBtn.addEventListener('click', () => restoreMessage(msg.id));

        const delBtn = document.createElement('button');
        delBtn.className = 'pill-btn secondary';
        delBtn.textContent = 'Delete forever';
        delBtn.addEventListener('click', () => deleteForever(msg.id));

        actions.append(restoreBtn, delBtn);
        item.appendChild(actions);
        binList.appendChild(item);
      });
    }

    async function openCameraModal() {
      cameraModal.classList.add('open');
      cameraError.textContent = '';
      const mediaDevices = navigator.mediaDevices;
      if (!mediaDevices?.getUserMedia) {
        cameraError.textContent = 'Camera is not supported in this browser.';
        return;
      }
      try {
        cameraStream = await mediaDevices.getUserMedia({ video: true });
        cameraPreview.srcObject = cameraStream;
        await cameraPreview.play();
      } catch (error) {
        console.error('Camera error', error);
        cameraError.textContent = 'Unable to access camera. Please check permissions or use a supported device.';
      }
    }

    function closeCameraModal() {
      cameraModal.classList.remove('open');
      if (cameraStream) {
        cameraStream.getTracks().forEach((t) => t.stop());
        cameraStream = null;
      }
      cameraPreview.srcObject = null;
    }

    async function capturePhoto() {
      if (!cameraStream) {
        cameraError.textContent = 'Camera is not ready. Please allow access.';
        return;
      }
      const track = cameraStream.getVideoTracks()[0];
      try {
        if ('ImageCapture' in window) {
          const capture = new ImageCapture(track);
          const blob = await capture.takePhoto();
          const reader = new FileReader();
          reader.onloadend = () => addMessage({ type: 'photo', content: reader.result });
          reader.readAsDataURL(blob);
        } else {
          const canvas = document.createElement('canvas');
          canvas.width = cameraPreview.videoWidth || 640;
          canvas.height = cameraPreview.videoHeight || 360;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/png');
          addMessage({ type: 'photo', content: dataUrl });
        }
        closeCameraModal();
      } catch (error) {
        console.error('Capture failed', error);
        cameraError.textContent = 'Unable to capture photo right now. Please try again.';
      }
    }

    function handlePhotoUpload(event) {
      const files = Array.from(event.target.files || []);
      if (!files.length) return;
      files.forEach((file) => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onloadend = () => {
          if (reader.result) {
            addMessage({ type: 'photo', content: reader.result });
          }
        };
        reader.readAsDataURL(file);
      });
      photoInput.value = '';
    }

    function toggleEmojiOutside(e) {
      if (!emojiTray.contains(e.target) && e.target !== emojiToggle) {
        emojiTray.classList.remove('open');
        emojiTray.setAttribute('aria-hidden', 'true');
      }
    }

    function init() {
      loadMessages();
      buildEmojiTray();
      renderMessages();
      renderBin();
      attachEvents();
      updateAppHeight();
      bindViewportListeners();
    }

    if (document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  </script>
</body>
</html>
